{% extends "assessment_base.html" %}
{% load static crispy_forms_tags %}

{% block main_content %}
    <div class="row" style="margin-top:45px;">
        <div class="col-12">
            <div class="card white-card">
                <div class="card-body">
                    <div class="container mb-4 mt-3">
                        <div class="row">
                            <div class="col-10 pl-0">
                                <h2 class="card-title mb-3 ml-3">
                                    Company footprint
                                </h2>
                            </div>
                            <div class="col-2">
                                <form action="{% url 'footprint_csv_download' %}" method="POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input id="risk_ids" type="hidden" name="risk_id[]">
                                    <input id="industry_ids" type="hidden" name="industry_ids[]">
                                    <input id="country_ids" type="hidden" name="country_ids[]">
                                    <input type="submit" name="Download CSV" value="Download CSV" class="btn btn-secondary ml-2 float-right" id="submit-id-submit">
                                </form>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <form id="company_footprint" action="{% url 'company_assessment_company_footprint' assessment.slug %}" method="POST" style="margin-top:55px;">
                                    {% crispy form %}
                                    <div class="form-group row">
                                        <div class="col-8"></div>
                                        <div class="col-4">
                                            <span class='float-right switch-wrapper pr-0'>
                                                <label class="font-semi-bold">Show risk comparisons</label>
                                                <label class="switch ml-3">
                                                    <input type="checkbox" class="start-on risk-checkbox">
                                                        <span class="slider risk-toggle round">
                                                    </span>
                                                </label>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="row inherent-comparison-wrapper">
                                        <div class="col inherent-risk" style="margin-bottom: 96px;">
                                            <span>Inherent risk</span>
                                        </div>
                                        {% if allow_score_edit %}
                                            <div type="Button" class="btn btn-secondary tgl-edit">Edit?</div>
                                            <select class="ml-4 d-none" id="customScoreSelect">
                                                <option value="">--Please choose an option--</option>
                                                {% for choice in score_options %}
                                                    <option {% if choice == assessment.custom_risk_score.text %}selected{% endif %}>{{ choice }}</option>
                                                {% endfor %}
                                            </select>

                                        {% endif %}
                                        <div class="col">
                                            <div class="rounded-circle risk-circle risk-score-wrapper">
                                                <div class="risk-text">
                                                    <div class="risk-score-text"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ml-2 inherent-risk-text">
                                            The inherent risk rating is presented on a scale from Low to High; it is based on the average of the risk scores associated with the top five combined key impacts for that company.
                                        </div>
                                    </div>

                                    <div class="industry-comparison-wrapper row form-group">
                                        <div class="mt-3 ml-2"><h3>Industry comparison</h3></div>
                                        <table id="records" class="table industry-comparison">
                                            <thead></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <div class="geo-comparison-wrapper row form-group">
                                        <div class="mt-3 m-2">
                                            <h3>Geographic comparison</h3>
                                            <p>Top 5 at-risk countries</p>
                                        </div>
                                        <table id="records" class="table geo-comparison">
                                            <thead></thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <br>
                                    <div class="buttonHolder" style="margin-top:60px;">
                                        <input type="submit" name="Next" value="Next" class="btn btn-primary  btn-medium" id="submit-id-submit">
                                        <a class="btn btn-secondary  btn-medium ml-2" href="{% url 'company_assessment_industries' assessment.slug %}">Previous</a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="riskInfoModel" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="model-description"></div>
                  </div>
                <div class="modal-footer">
                    <div class="risk-source"></div>
                    <button type="button" class="btn btn-tertiary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="industrySelectModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document" style="width: 53%;">
            <div class="modal-content" style="padding: 40px;!important">
                <div class="modal-header">
                    <i class="far fa-5x spinner d-none fa-spinner fa-spin"></i>
                    <h5 class="modal-title">Select all applicable industries</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" style="overflow-y: auto; height: 382px;">
                    <div class="model-description">{% include "includes/industry_dropdown.html" with industry_types=industry_types %}</div>
                  </div>
                <div class="modal-footer" style="border-top: 0">
                    <div class="risk-source"></div>
                    <button type="button" class="btn btn-tertiary cancelBrowseAdd" data-dismiss="modal">Cancel</button>
                    <button id="addIndustryBtn" type="button" class="btn btn-primary confirmBrowseAdd" data-dismiss="modal">Add</button>
                </div>
            </div>
        </div>
    </div>
    <div class="assessment-slug d-none" data-slug="{{ assessment.slug }}"></div>
    <div class='industry_select_url d-none'>{% url 'industry_select' %}</div>
    <div class='risk_description_url d-none'>{% url 'risk_description' %}</div>
    <div class='industry_table_url d-none'>{% url 'industry_table' %}</div>
    <div class='geographic_table_url d-none'>{% url 'geographic_table' %}</div>
    <div class='inherent_risk_url d-none'>{% url 'inherent_risk' %}</div>
    <a class="industry-options d-none" href="{% url 'industry_options' %}"></a>
    <a class="toggle-select d-none" href="{% url 'toggle_assessment_industry' %}"></a>
    <div class="total-count d-none">{{ total_count }}</div>
    {% if material_risks %}
        <div class='material_risks_data d-none'>{{ material_risks }}</div>
        <div class='industry_list_data d-none' >{{ industry_data }}</div>
    {% endif %}
    {% if sasb_industry %}
        <div class="sasb_industry d-none" data-sasb_industry="{{ sasb_industry.name }}"></div>
    {% endif %}
{% endblock %}

{% block js %}
    <script>
        document.getElementsByClassName("progress-wrapper")[0].style.visibility = 'hidden';
        window.onload = function () {
            document.getElementsByClassName("progress-wrapper")[0].style.visibility = ''
        }
        var htmlEncode = function (str) {
            if (str) {
                return str.replace(/<\/?[^>]+(>|$)/g, "");
            }
        };

        $(document).ready(function() {
            $('.industry-comparison-wrapper').hide();
            $('.geo-comparison-wrapper').hide();
            $('.inherent-comparison-wrapper').hide();

            if ($('.material_risks_data')) {
                var data = {
                    selected_risks: $('.material_risks_data').html(),
                };
                if ($('.industry_list_data').html()) {
                    data['selected_industries'] = $('.industry_list_data').html()
                }
                $.ajax({
                    type: "GET",
                    url: "{% url 'initial_selected_risk_options' %}",
                    data: data
                }).done(function( response ) {
                    $.map(response.risks, function(data) {
                        // Prevent duplicate selected options
                        if ($('#id_material_risks').find("option[value='" + data.id + "']").length) {
                            $("#id_material_risks option[value=" + data.id + "]").remove();
                            var newOption = new Option(data.text, data.id, true, true);
                            $('#id_material_risks').append(newOption).trigger('change');
                        }
                    });
                });
            }
            function formatSelected(state, container) {
                state.selected = true;
                var oldRisk = $('#risk_ids').val() + ','
                $('#risk_ids').val(oldRisk + state.id);
                var newState = state.text.split(",");
                container.attr('data-risk-id', state.id)
                if (newState.length == 1 || !newState[0].includes("risk-")) {
                    container.addClass('user-added');
                    if (newState[0] == 'None') {
                        return  $(
                            '<span>' +
                                "<i class='fad fa-user-alt white mr-2'></i>" +
                                htmlEncode(newState[1]) +
                            '</span>'
                        );
                    } else {
                        return  $(
                            '<span>' +
                                "<i class='fad fa-user-alt white mr-2'></i>" +
                                htmlEncode(newState[0]) +
                            '</span>'
                        );
                    }
                }
                var title = htmlEncode(newState[1]);
                var colour = newState[0];
                container.addClass(colour);
                state.title = title;
                return   $(
                    '<span>' +
                        title +
                    '</span>'
                );
            };
            $('#id_material_risks').select2({
                placeholder: 'Type to find',
                templateSelection: formatSelected,
                selectionTitleAttribute: false,
                ajax: {
                    url: "{% url 'risk_options' %}",
                    dataType: 'json',
                    type: "GET",
                    data: function (params) {
                        var excludeList = [];
                        $('.select2-selection__choice').each(function() {
                            if($(this).attr('data-risk-id')) {
                                excludeList.push($(this).attr('data-risk-id'));
                            }
                        });
                        return {
                            p: params.term,
                            page: params.page,
                            exclude: excludeList,
                        };
                    },
                    processResults: function (data, params) {
                        return {
                            results: data.risks,
                        };
                    },
                },
            });

            $('#id_countries').select2({
                placeholder:'Type to find',
            });
            var token = $("input[name='csrfmiddlewaretoken']").prop("value");

            $('.progress-link').on('click touch', function (event) {
                var form = $('#company_footprint');
                $.ajax({
                    type: "POST",
                    url: form.attr('action'),
                    data: form.serialize(),
                    success: function(data) {}
                });
            });

            $('.tgl-edit').on('click touch', function (event) {
                $( "#customScoreSelect" ).toggleClass('d-none');
            });

            $( "#customScoreSelect" ).change(function(obj) {
                $.ajax({
                    type: "GET",
                    url: "{% url 'custom_score_select' %}",
                    data: {
                        'custom_score': $( "#customScoreSelect option:selected" ).text(),
                        'assessment_slug': $('.assessment-slug').attr('data-slug'),
                    },
                    success: function(response) {
                        if ($('.risk-toggle').hasClass('slider-on') || $('.risk-toggle').hasClass('can-show-risk')) {
                            $('.inherent-comparison-wrapper').show();
                            var record;
                            if (response.responseJSON) {
                                record = response.responseJSON;
                            } else {
                                record = response;
                            }
                            $('.risk-score-text').html(record.score);
                            if ( record.score.includes("to")) {
                                $('.risk-score-text').css("font-size", 24 + "px").css('height', 65 + 'px');
                            } else {
                                $('.risk-score-text').css("font-size", 28 + "px").css('height', 49 + 'px');
                            }

                            if (record.colour) {
                                $('.risk-circle').css("background-color",record.colour);

                                if ('#ffe72f' === record.colour) {
                                    $('.risk-score-text').css('color', '#808080');
                                } else {
                                    $('.risk-score-text').css('color', '#fff');
                                }
                            }
                        }
                    }
                });
            });
        });
    </script>
    <script src="{% static 'js/footprint.js' %}"></script>
    <script src="{% static "js/industry_select.js" %}"></script>
{% endblock js %}
